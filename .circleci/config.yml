version: 2

variables:
  ubuntu-1804: &ubuntu-1804
    docker:
      - image: quay.io/dev-cafe/circleci_ubuntu-18.04-conda
        name: tsubame
        user: merzbow
    working_directory: ~/vampyr
  setup: &setup
    run:
      name: Create Conda environment
      command: |
        conda init bash
        conda create --name vampyr python=3.6
        conda env update --name vampyr --file environment.yml
  configure-serial: &configure-serial
    run:
      name: Configuring serial
      shell: /bin/bash
      command: |
        conda activate vampyr
        python ./setup \
          --type=release \
          --generator=Ninja \
          --cxx=g++ \
          --prefix=$HOME/Software/VAMPyR \
          --cmake-options="-DCMAKE_PREFIX_PATH=${CONDA_PREFIX} -DCMAKE_VERBOSE_MAKEFILE=ON"
  build: &build
    run:
      name: Building and installing
      shell: /bin/bash
      command: |
        cmake --build build --target install -- -v -d stats
  tests: &tests
    run:
      name: Testing
      shell: /bin/bash
      command: |
        cd build
        ctest --output-on-failure --verbose
        conda deactivate

jobs:
  serial-py3:
    <<: *ubuntu-1804
    steps:
      - checkout
      - *setup
      - *configure-serial
      - *build
      - *tests

workflows:
  version: 2
  build:
    jobs:
      - serial-py3
